<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NPC Meet</title>

  <!-- React + Babel + Tailwind (CDN for quick prototyping) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tiny helper for glowing ring animation -->
  <style>
    @keyframes speakGlow {
      0%   { box-shadow: 0 0 0 0 rgba(34,197,94,.6); }
      70%  { box-shadow: 0 0 0 10px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    .speaking { animation: speakGlow 1.5s ease-out infinite; }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div id="root"></div>

  <script type="text/babel">
/* -------------------------------------------------------------
   Helper components
------------------------------------------------------------- */
const NPCBubble = ({ name, isActive, lastLine }) => {
  const initials = name.split(" ").map(p => p[0]).join("").slice(0,2);
  return (
    <div className="flex flex-col items-center w-32 mx-2">
      <div
        className={
          "w-24 h-24 rounded-full bg-gray-700 flex items-center justify-center text-2xl font-semibold " +
          (isActive ? "speaking ring-4 ring-green-400" : "ring-2 ring-gray-600")
        }
      >
        {initials}
      </div>
      <span className="mt-1 text-sm text-gray-200">{name}</span>

      {lastLine && (
        <div className="mt-2 bg-gray-800 rounded-lg p-2 text-xs text-gray-100 max-w-xs">
          {lastLine}
        </div>
      )}
    </div>
  );
};

/* -------------------------------------------------------------
   Main App
------------------------------------------------------------- */
function MeetApp() {
  const [npcs, setNpcs]             = React.useState([]);
  const [lastLines, setLastLines]   = React.useState({});   // {npcName: text}
  const [active, setActive]         = React.useState(null); // name of last speaker
  const [input, setInput]           = React.useState("");
  const [busy, setBusy]             = React.useState(false);

  /* --- initial fetch of NPC roster ------------------------------------ */
  React.useEffect(() => {
    fetch("http://localhost:5000/npcs")
      .then(r => r.json())
      .then(data => setNpcs(data.npcs || []))
      .catch(err => console.error("Could not get NPC list:", err));
  }, []);

  /* --- idle poll to let NPCs talk on their own ------------------------ */
  React.useEffect(() => {
    const iv = setInterval(() => {
      fetch("http://localhost:5000/idle")
        .then(r => r.json())
        .then(data => {
          if (Array.isArray(data.responses)) {
            data.responses.forEach(({speaker, text}) => {
              appendMessage(speaker, text);
            });
          }
        })
        .catch(() => {});
    }, 9000);
    return () => clearInterval(iv);
  }, [lastLines]);

  /* --- helpers -------------------------------------------------------- */
  const appendMessage = (speaker, text) => {
    setLastLines(prev => ({ ...prev, [speaker]: text }));
    setActive(speaker);
  };

  const send = () => {
    if (!input.trim() || busy) return;
    setBusy(true);
    fetch("http://localhost:5000/chat", {
      method : "POST",
      headers: { "Content-Type":"application/json" },
      body   : JSON.stringify({ message: input.trim() })
    })
    .then(r => r.json())
    .then(({speaker, text}) => {
      appendMessage("User", input.trim());      // show what *you* said
      appendMessage(speaker, text);             // show NPC reply
      setInput("");
    })
    .finally(() => setBusy(false));
  };
const [micOn, setMicOn]   = React.useState(false);
  /* ----------------------------------------------------------- */
  return (
    <div className="flex flex-col h-screen">
      {/* ── NPC bubbles row ─────────────────────────── */}

      
      <div className="flex justify-center flex-wrap p-4 bg-gray-800">
        {npcs.map(npc => (
          <NPCBubble
            key={npc}
            name={npc}
            isActive={active === npc}
            lastLine={lastLines[npc]}
          />
        ))}
      </div>

      {/* ── spacer (just for look) ──────────────────── */}
      <div className="flex-1 flex items-center justify-center">
        <div className="text-gray-500 italic">
          {active ? `${active} is speaking…` : "Say something to start the conversation"}
        </div>
      </div>

      {/* ── input box ──────────────────────────────── */}
      <div className="p-4 bg-gray-800 border-t border-gray-700">
        <input
          className="w-full p-3 rounded bg-gray-700 text-white focus:outline-none"
          placeholder="Type here and press Enter…"
          value={input}
          onChange={e => setInput(e.target.value)}
          onKeyDown={e => e.key==="Enter" && send()}
          disabled={busy}
        />
        {/* MIC TOGGLE  ─────────────────────── */}
        <button
          onClick={() => {
            const next = !micOn;
            setMicOn(next);
            fetch("http://localhost:5000/voice", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ enable: next })
            });
          }}
          className={
            "w-12 h-12 rounded-full flex items-center justify-center " +
            (micOn ? "bg-red-500" : "bg-gray-600") +
            " hover:scale-105 transition"
          }
          title={micOn ? "Mute mic" : "Un-mute mic"}
        >
          {micOn ? "🎙️" : "🔇"}
        </button>
      </div>
      
    </div>
  );
}

ReactDOM.render(<MeetApp/>, document.getElementById("root"));
  </script>
</body>
</html>
