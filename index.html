<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function ChatApp() {
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const sendMessage = async () => {
                if (input.trim() === "" || loading) return;
                setLoading(true);
                try {
                    const res = await fetch('http://localhost:5000/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: input }),
                    });
                    const data = await res.json();
                    setMessages(prev => [
                        ...prev,
                        { speaker: "User", text: input },
                        { speaker: data.response.split(": ")[0], text: data.response.split(": ")[1] }
                    ]);
                    setInput("");
                } catch (error) {
                    console.error("Error:", error);
                } finally {
                    setLoading(false);
                }
            };

            const handleIdle = async () => {
                try {
                    const res = await fetch('http://localhost:5000/idle');
                    const data = await res.json();
                    if (data.responses.length > 0) {
                        setMessages(prev => [
                            ...prev,
                            ...data.responses.map(res => ({
                                speaker: res.split(": ")[0],
                                text: res.split(": ")[1]
                            }))
                        ]);
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            };

            React.useEffect(() => {
                const interval = setInterval(() => {
                    handleIdle();
                }, 10000); // Check every 10 seconds
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="flex flex-col h-screen bg-gray-100">
                    <div className="flex-1 overflow-y-auto p-4">
                        {messages.map((msg, index) => (
                            <div key={index} className={`mb-2 ${msg.speaker === "User" ? "text-right" : "text-left"}`}>
                                <span className={`inline-block p-2 rounded ${msg.speaker === "User" ? "bg-blue-200" : "bg-gray-200"}`}>
                                    <strong>{msg.speaker}:</strong> {msg.text}
                                </span>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 border-t bg-white">
                        <div className="flex">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === "Enter" && sendMessage()}
                                className="flex-1 p-2 border rounded-l focus:outline-none"
                                placeholder="Type your message..."
                                disabled={loading}
                            />
                            <button
                                onClick={sendMessage}
                                className="p-2 bg-blue-500 text-white rounded-r hover:bg-blue-600 disabled:bg-gray-400"
                                disabled={loading || input.trim() === ""}
                            >
                                {loading ? "Sending..." : "Send"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>